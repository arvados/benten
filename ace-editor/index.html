<!DOCTYPE html>
<html lang="en">
<head>
<title>Benten</title>

<script src="qrc:/qtwebchannel/qwebchannel.js" type="text/javascript"></script>
// This file comes bundled with Pyside2 and the resource bundler knows to include it ...
<script src="qrc:/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="qrc:/ace-builds/src-min-noconflict/ext-language_tools.js" type="text/javascript"></script>

<style type="text/css" media="screen">
    #editor {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // It is safest to set up this apparatus after the page has finished loading

    'use strict';

    var placeholder = document.getElementById('editor');

    var editor = ace.edit("editor");

    editor.session.setMode("ace/mode/yaml");
    editor.setAnimatedScroll(true)

    new QWebChannel(qt.webChannelTransport, function(channel) {
        // All the functions we use to communicate with the Python code are here

        var ipc = channel.objects.ipc

        ipc.fetch_text.connect( function() {
            ipc.send_text_python_side(editor.getValue(), function(val) {} );
            // Python functions return a value, even if it is None. So we need to pass a
            // dummy callback function to handle the return
        })

        ipc.send_text_js_side.connect(function(text) {
            editor.session.setValue(text)
        })

        ipc.apply_edit.connect( function(l0, c0, l1, c1, text) {
            var range = new Range(l0, c0, l1, c1)
            editor.addSelectionMarker(range)
            editor.insert(text)
        })

        editor.session.on('change', function(delta) {
            ipc.user_typing()
        })

        ipc.scroll_to.connect( function(line) {
            editor.scrollToLine(line, true)
            editor.navigateTo(line, 0)
        })

        ipc.send_error_annotations.connect( function(errs) {
            // https://stackoverflow.com/a/42122466/2512851
            editor.getSession().setAnnotations(errs)
        })

        // I do wish there was a way to retrieve a value from the slot
        ipc.set_option.connect(function (option, value) {
            editor.setOption(option, value)
        })
        ipc.set_snippets.connect(function (snippets) {
            var snippetManager = ace.require("ace/snippets").snippetManager
            snippetManager.register(snippets, "yaml");
        })
        ipc.fetch_settings()

        // Python based, context/syntax aware completer
        let langTools = ace.require('ace/ext/language_tools');
        var customCompleter = {
            getCompletions: function(editor, session, pos, prefix, callback) {
                ipc.send_auto_completions.connect(function(compl) {
                    callback(null, compl)
                })
                ipc.get_auto_completions(pos, prefix)
            }
        }
        // https://stackoverflow.com/a/27010052/2512851
        langTools.setCompleters([customCompleter])

        // This stuff we insist upon regardless of what the user sets
        editor.setOptions({
            useSoftTabs: true,
            navigateWithinSoftTabs: false,  // hmm, could cause confusion ...
            tabSize: 2,
            enableBasicAutocompletion: false,
            enableSnippets: true,
            enableLiveAutocompletion: true
        });

        ipc.editor_ready()
    });

});
</script>

</head>
<body>

<div id="editor">Seven Bridges Rabix Benten</div>

</body>
</html>